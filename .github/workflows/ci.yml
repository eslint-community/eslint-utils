name: CI

on:
    pull_request: ~
    push:
        branches:
            - main
    schedule:
        - cron: 0 0 * * 0

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

jobs:
    lint:
        name: â¬£ Lint
        runs-on: ubuntu-latest
        steps:
            - name: â¬‡ï¸ Checkout repo
              uses: actions/checkout@v6

            - name: â” Setup node
              uses: actions/setup-node@v6
              with:
                  node-version: lts/*
            - name: ğŸ“¥ Install dependencies
              run: npm install
            - name: â–¶ï¸ Run lint script
              run: npm run lint

    test:
        name:
            ğŸ§ª Test (Node@${{ matrix.node }} - ESLint@${{ matrix.eslint }} - ${{
            matrix.os }})
        strategy:
            matrix:
                eslint: [9]
                node: [18, 20, 22, 24]
                os: [ubuntu-latest]
                include:
                    # On other platforms
                    - os: windows-latest
                      eslint: 9
                      node: 24
                    - os: macos-latest
                      eslint: 9
                      node: 24
                    # On old Node versions & ESLint v8
                    - eslint: 8
                      node: 12.22.0
                      os: ubuntu-latest
                    - eslint: 8
                      node: 12
                      os: ubuntu-latest
                    - eslint: 8
                      node: 14.17.0
                      os: ubuntu-latest
                    - eslint: 8
                      node: 14
                      os: ubuntu-latest
                    - eslint: 8
                      node: 16
                      os: ubuntu-latest
                    # On old ESLint versions
                    - eslint: 7
                      node: 24
                      os: ubuntu-latest
                    - eslint: 6
                      node: 24
                      os: ubuntu-latest
                    # On the minimum supported ESLint/Node.js version
                    - eslint: 6.0.0
                      node: 12.22.0
                      os: ubuntu-latest
        runs-on: ${{ matrix.os }}
        steps:
            - name: â¬‡ï¸ Checkout repo
              uses: actions/checkout@v6

            - name: â” Setup Node v${{ matrix.node }}
              uses: actions/setup-node@v6
              with:
                  node-version: ${{ matrix.node }}

            # If we run this after `npm install`, it may hang with npm warnings.
            - name: ğŸ“¥ Install ESLint v${{ matrix.eslint }}
              run: npm install --save-dev eslint@${{ matrix.eslint }}

            - name: ğŸ“¥ Install dependencies
              run: npm install

            - name: ğŸ— Build
              run: npm run build

            - name: â–¶ï¸ Run test script
              run: |
                  npm run test-coverage

                  # Load src/index.mjs to check for syntax errors.
                  # This is because for some reason the exit code does not become 1 in Node.js 12.
                  # See https://github.com/eslint-community/eslint-utils/pull/253
                  node src/index.mjs

            - name: â¬†ï¸ Upload coverage report
              uses: codecov/codecov-action@v5
