name: CI
on:
    push:
        branches:
            # default semantic-release branches
            - +([0-9])?(.{+([0-9]),x}).x
            - main
            - next
            - next-major
            - beta
            - alpha
    pull_request:
    schedule:
        - cron: 0 0 * * 0

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

permissions:
    contents: write # to be able to publish a GitHub release
    id-token: write # to enable use of OIDC for npm provenance
    issues: write # to be able to comment on released issues
    pull-requests: write # to be able to comment on released pull requests

jobs:
    lint:
        name: â¬£ Lint
        runs-on: ubuntu-latest
        steps:
            - name: â¬‡ï¸ Checkout repo
              uses: actions/checkout@v6

            - name: â” Setup Node
              uses: actions/setup-node@v6
              with:
                  node-version: lts/*

            - name: ğŸ“¥ Install dependencies
              run: npm install

            - name: â–¶ï¸ Run lint script
              run: npm run lint

    test:
        name:
            ğŸ§ª Test (Node@${{ matrix.node }} - ESLint@${{ matrix.eslint }} - ${{
            matrix.os }})
        strategy:
            matrix:
                eslint: [9]
                node: ["20.19.0", 20, "22.13.1", 22, 24]
                os: [ubuntu-latest]
                include:
                    # On other platforms
                    - os: windows-latest
                      eslint: 9
                      node: lts/*
                    - os: macos-latest
                      eslint: 9
                      node: lts/*
                    # On old ESLint versions
                    - eslint: 8
                      node: 20
                      os: ubuntu-latest
                    - eslint: 7
                      node: 20
                      os: ubuntu-latest
                    - eslint: 6
                      node: 20
                      os: ubuntu-latest
        runs-on: ${{ matrix.os }}
        steps:
            - name: â¬‡ï¸ Checkout repo
              uses: actions/checkout@v6

            - name: â” Setup Node v${{ matrix.node }}
              uses: actions/setup-node@v6
              with:
                  node-version: ${{ matrix.node }}

            # If we run this after `npm install`, it may hang with npm warnings.
            - name: ğŸ“¥ Install ESLint v${{ matrix.eslint }}
              run: npm install --save-dev eslint@${{ matrix.eslint }}

            - name: ğŸ“¥ Install dependencies
              run: npm install

            - name: ğŸ— Build
              run: npm run build

            - name: â–¶ï¸ Run test script
              run: |
                  npm run test-coverage

                  # Load src/index.mjs to check for syntax errors.
                  # This is because for some reason the exit code does not become 1 in Node.js 12.
                  # See https://github.com/eslint-community/eslint-utils/pull/253
                  node src/index.mjs

            - name: â¬†ï¸ Upload coverage report
              uses: codecov/codecov-action@v5

    release:
        name: ğŸš€ Release
        needs: [lint, test]
        runs-on: ubuntu-latest
        if: github.repository == 'eslint-community/eslint-utils' &&
            contains('refs/heads/main,refs/heads/next,refs/heads/beta,refs/heads/alpha',
            github.ref) && github.event_name == 'push'
        steps:
            - name: â¬‡ï¸ Checkout repo
              uses: actions/checkout@v6

            - name: â” Setup node
              uses: actions/setup-node@v6
              with:
                  node-version: lts/*

            # npm 11.5.1 or later is required so update to latest to be sure
            - name: Update npm
              run: npm install -g npm@latest

            - name: ğŸ“¥ Install dependencies
              run: npm install

            - name: ğŸ— Build
              run: npm run build

            - name: ğŸš€ Release
              uses: cycjimmy/semantic-release-action@v6
              with:
                  # semantic-release@v25 is required for trusted publishing.
                  # https://github.com/semantic-release/semantic-release/releases/tag/v25.0.1
                  semantic_version: 25
                  branches: |
                      [
                        '+([0-9])?(.{+([0-9]),x}).x',
                        'main',
                        'next',
                        'next-major',
                        {name: 'beta', prerelease: true},
                        {name: 'alpha', prerelease: true}
                      ]
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  NPM_CONFIG_PROVENANCE: true
